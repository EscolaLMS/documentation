import{_ as a,o as s,c as e,V as n}from"./chunks/framework.c495fe11.js";const F=JSON.parse('{"title":"Payments","description":"","frontmatter":{},"headers":[],"relativePath":"packages/payments.md","filePath":"packages/payments.md"}'),o={name:"packages/payments.md"},t=n(`<h1 id="payments" tabindex="-1">Payments <a class="header-anchor" href="#payments" aria-label="Permalink to &quot;Payments&quot;">​</a></h1><p><a href="https://escolalms.github.io/payments/" target="_blank" rel="noreferrer"><img src="https://img.shields.io/badge/documentation-swagger-green" alt="swagger"></a><a href="https://codecov.io/gh/EscolaLMS/payments" target="_blank" rel="noreferrer"><img src="https://codecov.io/gh/EscolaLMS/Files/branch/main/graph/badge.svg?token=NRAN4R8AGZ" alt="codecov"></a><a href="https://github.com/EscolaLMS/payments/actions/workflows/test.yml" target="_blank" rel="noreferrer"><img src="https://github.com/EscolaLMS/payments/actions/workflows/test.yml/badge.svg" alt="phpunit"></a><a href="https://packagist.org/packages/escolalms/payments" target="_blank" rel="noreferrer"><img src="https://img.shields.io/packagist/dt/escolalms/payments" alt="downloads"></a><a href="https://packagist.org/packages/escolalms/payments" target="_blank" rel="noreferrer"><img src="https://img.shields.io/packagist/v/escolalms/payments" alt="downloads"></a><a href="https://packagist.org/packages/escolalms/payments" target="_blank" rel="noreferrer"><img src="https://img.shields.io/packagist/l/escolalms/payments" alt="downloads"></a><a href="https://codeclimate.com/github/EscolaLMS/payments/maintainability" target="_blank" rel="noreferrer"><img src="https://api.codeclimate.com/v1/badges/e42a94f20c76b719fc38/maintainability" alt="Maintainability"></a><a href="https://dashboard.stryker-mutator.io/reports/github.com/EscolaLMS/payments/main" target="_blank" rel="noreferrer"><img src="https://img.shields.io/endpoint?style=flat&amp;url=https%3A%2F%2Fbadge-api.stryker-mutator.io%2Fgithub.com%2FEscolaLMS%2Fpayments%2Fmain" alt="Mutation testing badge"></a></p><h2 id="purpose" tabindex="-1">Purpose <a class="header-anchor" href="#purpose" aria-label="Permalink to &quot;Purpose&quot;">​</a></h2><p>This package lets you create Payments and process them using integrations with external payment providers (gateways).</p><h2 id="dependencies" tabindex="-1">Dependencies <a class="header-anchor" href="#dependencies" aria-label="Permalink to &quot;Dependencies&quot;">​</a></h2><ul><li>Stripe integration is based on <code>league/omnipay</code> and <code>omnipay/stripe</code> packages.</li><li>Przelewy24 integration is based on <code>mnastalski/przelewy24-php</code> package.</li><li>Optional integration with <code>escolalms/settings</code> package enables changing payment gateway api keys &amp; secrets using Settings API (and Admin Panel).</li></ul><h2 id="installation" tabindex="-1">Installation <a class="header-anchor" href="#installation" aria-label="Permalink to &quot;Installation&quot;">​</a></h2><ul><li><code>composer require escolalms/payments</code></li><li><code>php artisan migrate</code></li><li><code>php artisan db:seed --class=&quot;EscolaLms\\Cart\\Database\\Seeders\\CartPermissionSeeder&quot;</code></li></ul><h2 id="usage" tabindex="-1">Usage <a class="header-anchor" href="#usage" aria-label="Permalink to &quot;Usage&quot;">​</a></h2><h3 id="facades" tabindex="-1">Facades <a class="header-anchor" href="#facades" aria-label="Permalink to &quot;Facades&quot;">​</a></h3><h4 id="payments-facade" tabindex="-1">Payments Facade <a class="header-anchor" href="#payments-facade" aria-label="Permalink to &quot;Payments Facade&quot;">​</a></h4><p>Use <code>EscolaLms\\Payments\\Facades\\Payments</code> for starting payment processing. You can create PaymentProcessor\` either from a model using Payable trait or from precreated Payment object.</p><div class="language-php"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> </span><span style="color:#A6ACCD;">EscolaLms</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Cart</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Models</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Cart</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> </span><span style="color:#A6ACCD;">EscolaLms</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Payments</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Dtos</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">PaymentMethodDto</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> </span><span style="color:#A6ACCD;">EscolaLms</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Payments</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Facades</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Payments</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">payable </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Cart</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">find</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// Cart must implement Payable interface and use Payable trait</span></span>
<span class="line"><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">paymentMethodDto </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">PaymentMethodDto</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">instantiateFromRequest</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">request</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">processor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Payments</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">processPayment</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">payable</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">processor</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#82AAFF;">purchase</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">paymentMethodDto</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// will emit PaymentPaid event on success</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">payment</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">status</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#82AAFF;">is</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">PaymentStatus</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">PAID</span><span style="color:#89DDFF;">)){</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// ...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h4 id="paymentgateway-facade" tabindex="-1">PaymentGateway Facade <a class="header-anchor" href="#paymentgateway-facade" aria-label="Permalink to &quot;PaymentGateway Facade&quot;">​</a></h4><p>With <code>EscolaLms\\Payments\\Facades\\PaymentGateway</code> you can call payment provider gateways directly.</p><p>For existing payment you can for example do:</p><div class="language-php"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> </span><span style="color:#A6ACCD;">EscolaLms</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Payments</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Dtos</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">PaymentMethodDto</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> </span><span style="color:#A6ACCD;">EscolaLms</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Payments</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Facades</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">PaymentGateway</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> </span><span style="color:#A6ACCD;">EscolaLms</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Payments</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Models</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Payment</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">payment </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Payment</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">find</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">paymentMethodDto </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">PaymentMethodDto</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">instantiateFromRequest</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">request</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">paymentDto </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">PaymentDto</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">instantiateFromPayment</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">payment</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// or you can create it manually</span></span>
<span class="line"><span style="color:#FFCB6B;">PaymentGateway</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">purchase</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">paymentDto</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">paymentMethodDto</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// will use default payment driver</span></span></code></pre></div><p><strong>Important</strong>: This will not save <code>Payment</code> object.</p><p>To use specific driver, you can call</p><div class="language-php"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">PaymentGateway</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">driver</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">stripe</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)-&gt;</span><span style="color:#82AAFF;">purchase</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">paymentDto</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">paymentMethodDto</span><span style="color:#89DDFF;">);</span></span></code></pre></div><h4 id="available-payment-drivers" tabindex="-1">Available payment drivers <a class="header-anchor" href="#available-payment-drivers" aria-label="Permalink to &quot;Available payment drivers&quot;">​</a></h4><ul><li><strong>stripe</strong> (using <code>Stripe Payment Intent</code>)</li><li><strong>free</strong></li><li><strong>przelewy24</strong></li><li>TODO: <em>stripe-checkout</em></li></ul><h3 id="payable-trait-interface" tabindex="-1">Payable Trait &amp; Interface <a class="header-anchor" href="#payable-trait-interface" aria-label="Permalink to &quot;Payable Trait &amp; Interface&quot;">​</a></h3><p><code>Payable</code> trait and interface are the core of this package, enabling simplified calling of <code>PaymentsService</code> and <code>GatewayManager</code>. When you include it in your model that represents a <code>Payable</code> (for example <code>Cart</code> or <code>Order</code> or <code>Product</code>) you can begin payment processing for that <code>Payable</code> by calling <code>$payable-&gt;process()</code> which calls <code>Payments::processPayable($this)</code> and automatically creates a <code>Payment</code> and returns a <code>PaymentProcessor</code> instance for that Payment.</p><p><code>EscolaLms\\Cart</code> package uses this trait and interface in <code>EscolaLms\\Cart\\Models\\Order</code>.</p><h3 id="payment-processor" tabindex="-1">Payment Processor <a class="header-anchor" href="#payment-processor" aria-label="Permalink to &quot;Payment Processor&quot;">​</a></h3><p><code>EscolaLms\\Payments\\Entities\\PaymentProcessor</code> is a special class which wraps around <code>Payment</code> and contains functionality related to processing that payment, for example generating links to payment gateways, automatically setting payment status after purchase, emiting events related to payment status, etc.</p><div class="language-php"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> </span><span style="color:#A6ACCD;">EscolaLms</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Payments</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Dtos</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">PaymentMethodDto</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> </span><span style="color:#A6ACCD;">EscolaLms</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Payments</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Entities</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">PaymentProcessor</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">use</span><span style="color:#FFCB6B;"> </span><span style="color:#A6ACCD;">EscolaLms</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Payments</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Models</span><span style="color:#89DDFF;">\\</span><span style="color:#A6ACCD;">Payment</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">payment </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Payment</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">find</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">paymentMethodDto </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">PaymentMethodDto</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">instantiateFromRequest</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">request</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">processor </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">PaymentProcessor</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">payment</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// instead of using Payments facade</span></span>
<span class="line"><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">processor</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#82AAFF;">purchase</span><span style="color:#89DDFF;">($</span><span style="color:#A6ACCD;">paymentMethodDto</span><span style="color:#89DDFF;">);</span></span></code></pre></div><p><code>PaymentProcessor</code> automatically selects <code>free</code> driver when payment amount equals 0.</p><h3 id="payment-model" tabindex="-1">Payment Model <a class="header-anchor" href="#payment-model" aria-label="Permalink to &quot;Payment Model&quot;">​</a></h3><p>This package defines a <code>EscolaLms\\Payments\\Models\\Payment</code> which contains all data abount given payment required for payment gateways to work.</p><h2 id="endpoints" tabindex="-1">Endpoints <a class="header-anchor" href="#endpoints" aria-label="Permalink to &quot;Endpoints&quot;">​</a></h2><p>All the endpoints are defined in <a href="https://escolalms.github.io/payments/" target="_blank" rel="noreferrer"><img src="https://img.shields.io/badge/documentation-swagger-green" alt="swagger"></a>.</p><h2 id="tests" tabindex="-1">Tests <a class="header-anchor" href="#tests" aria-label="Permalink to &quot;Tests&quot;">​</a></h2><p>Run <code>./vendor/bin/phpunit</code> to run tests. See <a href="https://github.com/EscolaLMS/payments/tree/main/tests/Mocks/Payable.php" target="_blank" rel="noreferrer">tests/Mocks/Payable</a> as an example how a Payable is defined.</p><p>Test details: <a href="https://codecov.io/gh/EscolaLMS/payments" target="_blank" rel="noreferrer"><img src="https://codecov.io/gh/EscolaLMS/Files/branch/main/graph/badge.svg?token=NRAN4R8AGZ" alt="codecov"></a><a href="https://github.com/EscolaLMS/payments/actions/workflows/test.yml" target="_blank" rel="noreferrer"><img src="https://github.com/EscolaLMS/payments/actions/workflows/test.yml/badge.svg" alt="phpunit"></a></p><h2 id="events" tabindex="-1">Events <a class="header-anchor" href="#events" aria-label="Permalink to &quot;Events&quot;">​</a></h2><ul><li><code>EscolaLms\\Payments\\Events\\PaymentCancelled</code> - - emited after payment processing is cancelled (by user action or possibly by timeout sent from payment gateway)</li><li><code>EscolaLms\\Payments\\Events\\PaymentFailed</code> - emited after payment has failed (payment gateway returns error)</li><li><code>EscolaLms\\Payments\\Events\\PaymentRegistered</code> - emited when new Payment is created</li><li><code>EscolaLms\\Payments\\Events\\PaymentSuccess</code> - emited when payment gateway returns success</li></ul><h2 id="listeners" tabindex="-1">Listeners <a class="header-anchor" href="#listeners" aria-label="Permalink to &quot;Listeners&quot;">​</a></h2><p>No Listeners are defined in this package.</p><h2 id="how-to-use-this-package-on-frontend" tabindex="-1">How to use this package on Frontend <a class="header-anchor" href="#how-to-use-this-package-on-frontend" aria-label="Permalink to &quot;How to use this package on Frontend&quot;">​</a></h2><h3 id="admin-panel" tabindex="-1">Admin Panel <a class="header-anchor" href="#admin-panel" aria-label="Permalink to &quot;Admin Panel&quot;">​</a></h3><h4 id="left-menu" tabindex="-1"><strong>Left Menu</strong> <a class="header-anchor" href="#left-menu" aria-label="Permalink to &quot;**Left Menu**&quot;">​</a></h4><p><img src="https://raw.githubusercontent.com/EscolaLMS/payments/main/docs/menu.png" alt="Admin panel menu" title="Admin panel menu"></p><h4 id="list-of-payments" tabindex="-1"><strong>List of Payments</strong> <a class="header-anchor" href="#list-of-payments" aria-label="Permalink to &quot;**List of Payments**&quot;">​</a></h4><p><img src="https://raw.githubusercontent.com/EscolaLMS/payments/main/docs/list.png" alt="List of Payments" title="List of Payments"></p><h2 id="permissions" tabindex="-1">Permissions <a class="header-anchor" href="#permissions" aria-label="Permalink to &quot;Permissions&quot;">​</a></h2><p>Permissions are defined in <a href="https://github.com/EscolaLMS/payments/tree/main/src/Enums/CartPermissionsEnum.php" target="_blank" rel="noreferrer">Enum</a> and seeded in <a href="database/seeders/CartPermissionSeeder.php">Seeder</a>.</p><h2 id="roadmap-todo-troubleshooting" tabindex="-1">Roadmap. Todo. Troubleshooting <a class="header-anchor" href="#roadmap-todo-troubleshooting" aria-label="Permalink to &quot;Roadmap. Todo. Troubleshooting&quot;">​</a></h2><ul><li>???</li></ul>`,50),l=[t];function p(r,c,i,y,d,m){return s(),e("div",null,l)}const h=a(o,[["render",p]]);export{F as __pageData,h as default};
